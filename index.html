<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover"/>
<title>‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö7‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏∞</title>
<style>
  :root{
    --bg:#fff0f6; --card:#ffffff; --text:#3a2a33; --muted:#6b6b6b;
    --pink:#ffcad4; --pink2:#ff99ac; --accent:#d6336c; --ok:#17a34a;
  }
  [data-theme="dark"]{
    --bg:#0f0a0c; --card:#161117; --text:#f6e9f0; --muted:#b9a8b1;
    --pink:#7a2a3a; --pink2:#b03c59; --accent:#ff6b9e; --ok:#34d399;
  }
  *{box-sizing:border-box}
  body{
    margin:0; min-height:100vh;
    font-family:"Sarabun",system-ui,-apple-system,"Segoe UI",Roboto,Arial,"Noto Sans Thai",sans-serif;
    color:var(--text);
    background: radial-gradient(1200px 1200px at 80% -20%, #ffd6e7 0%, var(--bg) 60%);
    overflow-x:hidden;
  }
  .float-heart{ position:fixed; opacity:.35; animation: rise 14s linear infinite; pointer-events:none; filter: blur(.2px)}
  @keyframes rise{ from{ transform: translateY(110vh) scale(.7) rotate(0) } to{ transform: translateY(-15vh) scale(1.1) rotate(360deg) } }

  .wrap{ width:100%; max-width:1080px; margin:0 auto; padding:28px; display:grid; gap:24px; grid-template-columns: repeat(auto-fit, minm ax(300px, 1fr)); align-items:start; }
  header{ grid-column:1/-1; text-align:center }
  h1{ margin:0 0 8px; color:var(--accent); font-weight:900; letter-spacing:.3px }
  .sub{ color:var(--muted); font-size:14px }

  .toolbar{ grid-column:1/-1; display:flex; gap:10px; justify-content:center; flex-wrap:wrap; padding-bottom: env(safe-area-inset-bottom); }
  .chip{ border:1.5px solid var(--accent); color:var(--accent); background:transparent; padding:10px 14px; border-radius:999px; font-weight:700; cursor:pointer }
  .chip.active{ background:var(--accent); color:#fff }

  .card{ background:var(--card); border-radius:18px; padding:18px 18px 24px; box-shadow: 0 18px 60px rgba(0,0,0,.12) }
  .card h2{ margin:2px 0 8px; font-size:18px }

  .envelope{ width:280px; height:170px; margin:14px auto 10px; position:relative; cursor:pointer; perspective:800px; transition: transform .2s ease; touch-action:none }
  .tilt:hover{ transform: translateY(-3px) }
  .env-body{ position:absolute; inset:0; background:var(--pink); border-radius:10px; box-shadow: inset 0 -8px 0 rgba(0,0,0,.07) }
  .env-flap{ position:absolute; left:0; right:0; top:0; height:0;
    border-left:140px solid transparent; border-right:140px solid transparent; border-bottom:85px solid var(--pink2);
    transform-origin: top center; transition: transform .6s cubic-bezier(.2,.7,.2,1.1); backface-visibility:hidden; }
  .letter-sheet{ position:absolute; left:12px; right:12px; top:60px; height:0; background:#fff; border-radius:10px; overflow:hidden;
    box-shadow:0 8px 16px rgba(0,0,0,.12); transition: height .6s ease, top .6s ease; }
  .envelope.open .env-flap{ transform: rotateX(180deg) }
  .envelope.open .letter-sheet{ height:130px; top:-8px }

  .row-actions{ display:flex; gap:10px; flex-wrap:wrap; justify-content:center; margin-top:8px }
  .btn{ border:0; border-radius:999px; padding:12px 16px; font-weight:800; cursor:pointer; background:var(--accent); color:white; box-shadow: 0 10px 24px rgba(214,51,108,.25) }
  .btn.ghost{ background:transparent; color:var(--accent); border:2px solid var(--accent) }

  .letter{ display:none } /* ‡πÉ‡∏ä‡πâ Pop-up A4 ‡πÅ‡∏ó‡∏ô */

  .countdown{ margin-top:10px; display:grid; gap:10px; grid-template-columns: 100px 1fr; align-items:center }
  .progress{ width:100px; height:100px; }
  .progress circle{ fill:none; stroke-width:10; stroke-linecap:round }
  .progress .track{ stroke: #eee } [data-theme="dark"] .progress .track{ stroke:#2a2227 }
  .progress .bar{ stroke: var(--accent); transform: rotate(-90deg); transform-origin:50% 50%; transition: stroke-dashoffset .8s ease }
  .cd-text{ font-size:14px; color:var(--muted) }

  .hint{ color:var(--muted); font-size:13px; margin-top:6px; text-align:center }
  .shake{ animation: shake .5s ease } @keyframes shake{
    10%,90%{ transform: translateX(-1px) } 20%,80%{ transform: translateX(2px) }
    30%,50%,70%{ transform: translateX(-4px) } 40%,60%{ transform: translateX(4px) } }

  /* ===== A4 POPUP (Fit to screen) ===== */
  .modal{
    position:fixed; inset:0; display:none; align-items:center; justify-content:center;
    padding: clamp(8px,2vmin,24px);
    padding-left: calc(clamp(8px,2vmin,24px) + env(safe-area-inset-left));
    padding-right: calc(clamp(8px,2vmin,24px) + env(safe-area-inset-right));
    padding-top: calc(clamp(8px,2vmin,24px) + env(safe-area-inset-top));
    padding-bottom: calc(clamp(8px,2vmin,24px) + env(safe-area-inset-bottom));
    background: rgba(0,0,0,.6);
    z-index:60;
  }
  .modal.show{ display:flex }
  .sheet{
    background:#fff; color:#222; border-radius:10px; box-shadow: 0 30px 80px rgba(0,0,0,.45);
    /* ‡∏ü‡∏¥‡∏ï‡∏à‡∏≠: ‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏™‡πà‡∏ß‡∏ô 210/297, ‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 98vw ‡πÅ‡∏•‡∏∞‡∏™‡∏π‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 98vh */
    width: min(98vw, calc(98vh * 210 / 297));
    aspect-ratio: 210 / 297; /* ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á‡∏à‡∏∞‡∏ï‡∏≤‡∏°‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏™‡πà‡∏ß‡∏ô‡πÄ‡∏™‡∏°‡∏≠ ‚Üí ‡πÑ‡∏°‡πà‡∏•‡πâ‡∏ô 98vh */
    display:grid; grid-template-rows:auto 1fr; overflow:hidden;
    max-height: 98vh;  /* ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á‡∏à‡∏≠ */
    max-width: 98vw;   /* ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡∏à‡∏≠ */
  }
  .sheet-head{ display:flex; align-items:center; justify-content:space-between; gap:8px;
    padding:10px 14px; background:#f7f7f7; border-bottom:1px solid #e9e9e9 }
  .sheet-title{ font-weight:900; color:#c2255c; overflow:hidden; text-overflow:ellipsis; white-space:nowrap }
  .sheet-actions{ display:flex; gap:8px }
  .icon-btn{ border:1px solid #ddd; background:#fff; border-radius:10px; padding:10px 14px; cursor:pointer; font-weight:700 }
  .icon-btn.print{ background:#111; color:#fff; border-color:#111 }
  .sheet-body{
    padding:18px 22px; overflow:auto; line-height:1.75; font-size:16px; background:#fff; position:relative;
  }
  .sheet-body .typed{ white-space:pre-wrap }
  .a4-photos{ display:grid; gap:14px; margin-top:14px }
  .a4-photos img{ width:100%; border-radius:10px; box-shadow: 0 10px 24px rgba(0,0,0,.12); cursor:zoom-in }

  /* Lightbox */
  .lightbox{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,.88); z-index:70; }
  .lightbox.show{ display:flex }
  .lightbox img{ max-width:92vw; max-height:92vh; border-radius:14px; box-shadow: 0 20px 80px rgba(0,0,0,.5) }
  .lightbox .close{ position:absolute; top:calc(16px + env(safe-area-inset-top)); right:18px; color:white; font-weight:900; font-size:24px; cursor:pointer }

  /* ===== Mobile tweaks ===== */
  @media (max-width: 520px){
    .wrap{ padding:16px; gap:16px }
    h1{ font-size:22px }
    .chip{ padding:9px 12px; font-size:14px }
    .card{ padding:14px }
    .envelope{ width:220px; height:140px }
    .env-flap{ border-left:110px solid transparent; border-right:110px solid transparent; border-bottom:70px solid var(--pink2) }
    .letter-sheet{ left:10px; right:10px; top:52px }
    .btn{ padding:11px 14px; font-size:14px }
    .progress{ width:86px; height:86px }
    .cd-text{ font-size:13px }
    .sheet-body{ font-size:15px }
  }
  /* ‡∏à‡∏≠‡πÄ‡∏ï‡∏µ‡πâ‡∏¢ (‡πÅ‡∏ô‡∏ß‡∏ô‡∏≠‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ ‡∏Ø‡∏•‡∏Ø) ‚Üí ‡∏•‡∏î padding ‡∏†‡∏≤‡∏¢‡πÉ‡∏ô‡πÅ‡∏ú‡πà‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÑ‡∏°‡πà‡∏•‡πâ‡∏ô */
  @media (max-height: 520px){
    .sheet-body{ padding:12px 14px; line-height:1.6 }
    .icon-btn{ padding:8px 10px }
  }

  /* Print: ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÅ‡∏ú‡πà‡∏ô A4 */
  @media print{
    body{ background:#fff }
    .wrap, .float-heart, #confetti, .lightbox{ display:none !important }
    .modal{ display:block !important; background:transparent; padding:0 }
    .sheet{ width:auto; aspect-ratio:auto; height:auto; box-shadow:none; border-radius:0 }
    .sheet-head{ display:none }
    .sheet-body{ background:#fff; overflow:visible }
    @page{ size: A4; margin:12mm }
  }
</style>
</head>
<body>
  <!-- floating hearts -->
  <canvas id="confetti"></canvas>

  <!-- A4 Popup -->
  <div id="modal" class="modal" aria-hidden="true">
    <div class="sheet" role="dialog" aria-modal="true" aria-labelledby="sheetTitle">
      <div class="sheet-head">
        <div id="sheetTitle" class="sheet-title">‡∏à‡∏î‡∏´‡∏°‡∏≤‡∏¢</div>
        <div class="sheet-actions">
          <button class="icon-btn print" id="btnPrint">‡∏û‡∏¥‡∏°‡∏û‡πå/‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å PDF</button>
          <button class="icon-btn" id="btnClose">‡∏õ‡∏¥‡∏î</button>
        </div>
      </div>
      <div class="sheet-body" id="sheetBody"></div>
    </div>
  </div>

  <!-- Lightbox -->
  <div id="lightbox" class="lightbox" aria-hidden="true">
    <span class="close" aria-label="Close">‚úï</span>
    <img alt="">
  </div>

  <div class="wrap">
    <header>
      <h1>‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏î‡πâ‡∏ß‡∏¢‡∏Å‡∏±‡∏ô‡∏°‡∏≤ 7 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏∞ üíï</h1>
      <div class="sub">‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏î‡∏µ‡πÜ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡πÉ‡∏´‡πâ‡πÄ‡∏£‡∏≤‡∏°‡∏≤‡∏ï‡∏•‡∏≠‡∏î7‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏∞‡∏Ñ‡∏£‡∏±‡∏ö</div>
    </header>

    <div class="toolbar">
      <button id="toggleTheme" class="chip">‡∏™‡∏•‡∏±‡∏ö‡πÇ‡∏´‡∏°‡∏î‡∏™‡∏ß‡πà‡∏≤‡∏á/‡∏°‡∏∑‡∏î</button>
      <button id="toggleSound" class="chip">‡πÄ‡∏™‡∏µ‡∏¢‡∏á: ‡∏õ‡∏¥‡∏î</button>
      <button id="secretBtn" class="chip">‡∏™‡∏ï‡∏¥‡∏Å‡πÄ‡∏Å‡∏≠‡∏£‡πå‡∏´‡∏±‡∏ß‡πÉ‡∏à üíó</button>
    </div>

    <!-- ‡∏ã‡∏≠‡∏á‡πÄ‡∏õ‡∏¥‡∏î‡πÑ‡∏î‡πâ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ -->
    <section class="card">
      <h2>‡∏ã‡∏≠‡∏á‡∏à‡∏î‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏õ‡∏¥‡∏î‡πÑ‡∏î‡πâ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ üíå</h2>
      <div id="envOpen" class="envelope tilt" aria-label="‡πÄ‡∏õ‡∏¥‡∏î‡∏à‡∏î‡∏´‡∏°‡∏≤‡∏¢‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì">
        <div class="env-body"></div><div class="env-flap"></div><div class="letter-sheet"></div>
      </div>
      <div class="row-actions">
        <button class="btn" id="btnOpenNow">‡πÄ‡∏õ‡∏¥‡∏î‡∏à‡∏î‡∏´‡∏°‡∏≤‡∏¢</button>
        <button class="btn ghost" id="btnAnim1">‡πÅ‡∏™‡∏î‡∏á/‡∏ã‡πà‡∏≠‡∏ô‡πÅ‡∏≠‡∏ô‡∏¥‡πÄ‡∏°‡∏ä‡∏±‡∏ô‡∏ã‡∏≠‡∏á</button>
      </div>
      <div id="letter1" class="letter"></div>
      <div class="hint">‡πÅ‡∏ï‡∏∞/‡∏•‡∏≤‡∏Å‡∏ö‡∏ô‡∏ã‡∏≠‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏≠‡∏µ‡∏¢‡∏á‡πÅ‡∏ö‡∏ö 3D üì±</div>
    </section>

    <!-- ‡∏ã‡∏≠‡∏á‡∏•‡πá‡∏≠‡∏Å (‡πÑ‡∏°‡πà‡πÇ‡∏ä‡∏ß‡πå‡πÄ‡∏ß‡∏•‡∏≤) -->
    <section class="card">
      <h2>‡∏ã‡∏≠‡∏á‡∏à‡∏î‡∏´‡∏°‡∏≤‡∏¢‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÄ‡∏õ‡∏¥‡∏î‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ ‚è≥</h2>
      <div id="envLocked" class="envelope tilt" aria-label="‡∏ã‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÄ‡∏õ‡∏¥‡∏î‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ">
        <div class="env-body"></div><div class="env-flap"></div><div class="letter-sheet"></div>
      </div>

      <div class="countdown">
        <svg class="progress" viewBox="0 0 120 120" width="110" height="110" aria-hidden="true">
          <circle class="track" cx="60" cy="60" r="48"></circle>
          <circle class="bar" cx="60" cy="60" r="48" stroke-dasharray="301.59" stroke-dashoffset="301.59"></circle>
        </svg>
        <div>
          <div id="lockedState" class="cd-text"><b>‡∏à‡∏∞‡πÄ‡∏õ‡∏¥‡∏î‡πÑ‡∏î‡πâ‡∏Å‡πá‡∏ï‡πà‡∏≠‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏î‡∏ß‡∏á‡∏î‡∏≤‡∏ß‡∏Ç‡∏≠‡∏á‡πÄ‡∏£‡∏≤‡∏ó‡∏±‡πâ‡∏á2‡∏à‡∏∞‡πÇ‡∏Ñ‡∏à‡∏£‡∏°‡∏≤‡πÄ‡∏à‡∏≠‡∏Å‡∏±‡∏ô</b></div>
          <div id="cdDetail" class="cd-text" style="display:none"></div>
        </div>
      </div>

      <div class="row-actions">
        <button class="btn" id="btnOpenLocked">‡∏•‡∏≠‡∏á‡πÄ‡∏õ‡∏¥‡∏î‡∏î‡∏π</button>
        <button class="btn ghost" id="btnAnim2">‡πÅ‡∏™‡∏î‡∏á/‡∏ã‡πà‡∏≠‡∏ô‡πÅ‡∏≠‡∏ô‡∏¥‡πÄ‡∏°‡∏ä‡∏±‡∏ô‡∏ã‡∏≠‡∏á</button>
      </div>

      <div id="letter2" class="letter"></div>
      <div class="hint">* ‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÑ‡∏´‡∏£‡πà‡πÄ‡∏£‡∏≤‡∏à‡∏∞‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏´‡πâ‡πÄ‡∏≠‡∏á‡∏ô‡∏∞üòâ *</div>
    </section>
  </div>

<script>
/* =======================
   üîß CONFIG ‚Äî ‡πÅ‡∏Å‡πâ‡∏Ñ‡πà‡∏≤‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
   ======================= */
const CONFIG = {
  OPEN_AT: "2025-12-31T21:30", // ‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏õ‡∏¥‡∏î (‡πÑ‡∏°‡πà‡πÅ‡∏™‡∏î‡∏á‡∏ï‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ)
  LOCKED_TITLE: "‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏≤‡∏ß‡∏ô‡∏°‡∏≤‡πÄ‡∏à‡∏≠‡∏Å‡∏±‡∏ô‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á üåèüíû",
  LOCKED_CONTENT:
`‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏Ç‡πâ‡∏≤‡∏á‡πÜ ‡∏Å‡∏±‡∏ô‡πÄ‡∏™‡∏°‡∏≠
‡∏ï‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÇ‡∏•‡∏Å‡∏´‡∏°‡∏∏‡∏ô‡∏û‡∏≤‡πÄ‡∏£‡∏≤‡πÑ‡∏Å‡∏•‡πÅ‡∏Ñ‡πà‡πÑ‡∏´‡∏ô ‡πÄ‡∏£‡∏≤‡∏Å‡πá‡∏à‡∏∞‡∏ß‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡∏´‡∏≤‡∏Å‡∏±‡∏ô
‡∏ñ‡∏∂‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ô‡∏±‡πâ‡∏ô‚Ä¶ ‡∏°‡∏≤‡πÄ‡∏õ‡∏¥‡∏î‡∏à‡∏î‡∏´‡∏°‡∏≤‡∏¢‡∏ô‡∏µ‡πâ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏±‡∏ô‡∏ô‡∏∞ üí´`,
  LOCKED_IMAGES: [
    // { src: "images/us-1.jpg", caption: "‡∏ß‡∏±‡∏ô‡πÅ‡∏£‡∏Å‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏≤‡πÄ‡∏à‡∏≠‡∏Å‡∏±‡∏ô üíû" },
  ],
  AUTO_OPEN: true
};

const prefersDark = matchMedia && matchMedia('(prefers-color-scheme: dark)').matches;
const savedTheme = localStorage.getItem('theme');
document.documentElement.setAttribute('data-theme', savedTheme || (prefersDark?'dark':'light'));

let soundOn = (localStorage.getItem('sound')||'off')==='on';
const $ = s => document.querySelector(s);

const envOpen = $('#envOpen'), envLocked = $('#envLocked');
const btnOpenNow = $('#btnOpenNow'), btnOpenLocked = $('#btnOpenLocked');
const btnAnim1 = $('#btnAnim1'), btnAnim2 = $('#btnAnim2');
const toggleTheme = $('#toggleTheme'), toggleSound = $('#toggleSound'), secretBtn = $('#secretBtn');

const modal = $('#modal'), sheetTitle = $('#sheetTitle'), sheetBody = $('#sheetBody');
const btnPrint = $('#btnPrint'), btnClose = $('#btnClose');
const lightbox = $('#lightbox'), lightboxImg = lightbox.querySelector('img'), lightboxClose = lightbox.querySelector('.close');

toggleSound.classList.toggle('active', soundOn);
toggleSound.textContent = `‡πÄ‡∏™‡∏µ‡∏¢‡∏á: ${soundOn ? '‡πÄ‡∏õ‡∏¥‡∏î' : '‡∏õ‡∏¥‡∏î'}`;

// floating hearts (‡∏•‡∏î‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ö‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠)
(function hearts(){
  const coarse = matchMedia('(pointer:coarse)').matches;
  const n = coarse ? 10 : 14;
  for(let i=0;i<n;i++){
    const h=document.createElement('div'); h.className='float-heart'; h.textContent='üíó';
    h.style.left = (Math.random()*100)+'vw';
    h.style.fontSize = (18+Math.random()*26)+'px';
    h.style.animationDelay = (Math.random()*-14)+'s';
    document.body.appendChild(h);
  }
})();

// Tilt (mouse + touch)
function bindTilt(el){
  let rect;
  const maxX = 10, maxY = 8;
  function update(clientX, clientY){
    if(!rect) rect = el.getBoundingClientRect();
    const x = (clientX - rect.left) / rect.width - .5;
    const y = (clientY - rect.top) / rect.height - .5;
    el.style.transform = `rotateX(${(-y*maxY).toFixed(2)}deg) rotateY(${(x*maxX).toFixed(2)}deg) translateY(-3px)`;
  }
  el.addEventListener('pointerenter', ()=> rect = el.getBoundingClientRect());
  el.addEventListener('pointermove', e=>{
    if (e.pointerType==='touch' && e.pressure===0) return;
    update(e.clientX, e.clientY);
  });
  el.addEventListener('pointerdown', e=>{ el.setPointerCapture?.(e.pointerId); rect = el.getBoundingClientRect(); update(e.clientX, e.clientY); });
  el.addEventListener('pointerup', ()=> el.style.transform = '');
  el.addEventListener('pointerleave', ()=> el.style.transform = '');
}
bindTilt(envOpen); bindTilt(envLocked);

// Typewriter
function typewriter(el, text, speed=16, done){
  el.innerHTML = '<div class="typed"></div>';
  const target = el.querySelector('.typed');
  const esc = s => s.replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  let i=0;
  (function step(){
    if(i<=text.length){
      target.innerHTML = esc(text.slice(0,i)).replace(/\n/g,'<br>');
      i++; setTimeout(step, speed);
    } else { if (typeof done==='function') done(); }
  })();
}

// Audio chime
let audioCtx=null;
function chime(){
  if(!soundOn) return;
  try{
    audioCtx = audioCtx || new (window.AudioContext||window.webkitAudioContext)();
    const o=audioCtx.createOscillator(), g=audioCtx.createGain();
    o.connect(g); g.connect(audioCtx.destination); o.type='triangle'; o.frequency.value=880;
    g.gain.setValueAtTime(0.0001,audioCtx.currentTime);
    g.gain.exponentialRampToValueAtTime(0.2,audioCtx.currentTime+0.02);
    g.gain.exponentialRampToValueAtTime(0.0001,audioCtx.currentTime+0.35);
    o.start(); o.stop(audioCtx.currentTime+0.4);
    if (navigator.vibrate) navigator.vibrate(20);
  }catch{}
}

// Confetti (‡πÄ‡∏ö‡∏≤‡∏•‡∏á‡∏ö‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠)
const cvs = document.getElementById('confetti'), ctx = cvs.getContext('2d'); let parts=[];
function resize(){ cvs.width=innerWidth; cvs.height=innerHeight } addEventListener('resize',resize); resize();
function blast(x=innerWidth/2,y=innerHeight/3,n=120){
  const coarse = matchMedia('(pointer:coarse)').matches;
  const count = coarse ? Math.floor(n*0.55) : n;
  for(let i=0;i<count;i++){
    parts.push({x,y,vx:(Math.random()-.5)*6,vy:(Math.random()-1.2)*8-4,g:.15+Math.random()*.25,s:4+Math.random()*6,a:1,hue:Math.floor(Math.random()*360)});
  }
}
;(function loop(){ ctx.clearRect(0,0,cvs.width,cvs.height); parts=parts.filter(p=>p.a>0&&p.y<innerHeight+40);
  for(const p of parts){ p.vx*=0.995; p.vy+=p.g; p.x+=p.vx; p.y+=p.vy; p.a*=0.986; ctx.globalAlpha=Math.max(0,p.a); ctx.fillStyle=`hsl(${p.hue} 90% 60%)`; ctx.fillRect(p.x,p.y,p.s,p.s);} requestAnimationFrame(loop); })();

// Lock body scroll when modal open
function lockScroll(lock){ document.body.style.overflow = lock ? 'hidden' : ''; }

// A4 Popup
function openA4(title, text, images){
  sheetTitle.textContent = title || '‡∏à‡∏î‡∏´‡∏°‡∏≤‡∏¢';
  sheetBody.scrollTop = 0;
  sheetBody.innerHTML = '';
  typewriter(sheetBody, (title?`üì¨ ${title}\n\n`:'') + (text||''), 16, ()=>{
    if (Array.isArray(images) && images.length){
      const grid = document.createElement('div'); grid.className = 'a4-photos';
      images.forEach(({src, caption=''})=>{
        const fig = document.createElement('figure'); fig.style.margin='0';
        const img = document.createElement('img'); img.loading='lazy'; img.decoding='async'; img.src=src; img.alt=caption||'';
        const cap = document.createElement('figcaption'); cap.style.fontSize='13px'; cap.style.color='#6b6b6b'; cap.style.textAlign='center'; cap.style.marginTop='6px'; cap.textContent = caption||'';
        img.addEventListener('click', ()=> openLightbox(src, caption||''));
        fig.appendChild(img); if (caption) fig.appendChild(cap);
        grid.appendChild(fig);
      });
      sheetBody.appendChild(grid);
    }
  });
  modal.classList.add('show'); modal.setAttribute('aria-hidden','false'); lockScroll(true);
}
function closeA4(){ modal.classList.remove('show'); modal.setAttribute('aria-hidden','true'); lockScroll(false); }
btnClose.addEventListener('click', closeA4);
modal.addEventListener('click', (e)=>{ if (e.target === modal) closeA4(); });
btnPrint.addEventListener('click', ()=> window.print());

// Lightbox
let lbStartY=null;
function openLightbox(src, alt){ lightboxImg.src = src; lightboxImg.alt = alt||''; lightbox.classList.add('show'); lightbox.setAttribute('aria-hidden','false'); }
function closeLightbox(){ lightbox.classList.remove('show'); lightbox.setAttribute('aria-hidden','true'); setTimeout(()=> (lightboxImg.src=''), 200); }
lightbox.addEventListener('click', (e)=>{ if (e.target===lightbox || e.target===lightboxClose) closeLightbox(); });
lightbox.addEventListener('pointerdown', e=>{ lbStartY = e.clientY; });
lightbox.addEventListener('pointerup', e=>{ if (lbStartY!=null && e.clientY - lbStartY > 60) closeLightbox(); lbStartY=null; });
addEventListener('keydown', (e)=>{ if (e.key==='Escape' && lightbox.classList.contains('show')) closeLightbox(); });

// Open-now -> A4
const OPEN_TEXT =
`üíå ‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏î‡∏µ‡πÜ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡πÉ‡∏´‡πâ‡πÄ‡∏£‡∏≤‡∏°‡∏≤‡∏ï‡∏•‡∏≠‡∏î7‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏∞‡∏Ñ‡∏£‡∏±‡∏ö
‡∏£‡∏≠‡∏ö‡∏ô‡∏µ‡πâ‡∏≠‡∏≤‡∏à‡∏à‡∏∞‡∏°‡∏≤‡∏ä‡πâ‡∏≤‡πÑ‡∏õ‡∏´‡∏ô‡πà‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡πá‡πÑ‡∏°‡πà‡∏£‡∏π‡πâ‡∏ß‡πà‡∏≤‡πÄ‡∏£‡∏≤‡∏à‡∏∞‡πÑ‡∏î‡πâ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏≠‡∏µ‡∏Å
‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÑ‡∏´‡∏£‡πà‡πÅ‡∏ï‡πà‡∏Å‡πá‡∏à‡∏∞‡∏£‡∏≠‡∏ô‡πâ‡∏≠‡∏á‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡πÄ‡∏õ‡∏¥‡∏î‡∏à‡∏î‡∏´‡∏°‡∏≤‡∏¢‡∏≠‡∏µ‡∏Å‡∏ã‡∏≠‡∏á‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÜ
‡∏Å‡∏±‡∏ö‡πÄ‡∏£‡∏≤‡∏ô‡∏∞‡∏Ñ‡∏£‡∏±‡∏ö
‡πÄ‡∏£‡∏≤‡πÑ‡∏°‡πà‡∏£‡∏π‡πâ‡∏´‡∏£‡∏≠‡∏Å‡∏ß‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏ú‡πà‡∏≤‡∏ô‡∏°‡∏≤‡∏ô‡πâ‡∏≠‡∏á‡∏à‡∏∞‡∏£‡∏±‡∏Å‡πÄ‡∏£‡∏≤‡∏à‡∏£‡∏¥‡∏á‡∏£‡∏∂‡∏õ‡πà‡∏≤‡∏ß‡∏´‡∏£‡∏∑‡∏≠‡∏ß‡πà‡∏≤‡∏à‡∏∞‡πÅ‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏¢‡∏Å‡∏±‡∏ö‡πÉ‡∏Ñ‡∏£
‡πÅ‡∏ï‡πà‡πÄ‡∏£‡∏≤‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∏‡∏Ç‡∏°‡∏≤‡∏Å‡πÜ‡∏ï‡∏•‡∏≠‡∏î‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏ú‡πà‡∏≤‡∏ô‡∏°‡∏≤‡πÄ‡∏£‡∏≤‡∏£‡∏±‡∏Å‡∏ô‡πâ‡∏≠‡∏á‡∏°‡∏≤‡∏Å‡πÜ‡∏à‡∏≤‡∏Å
‡πÑ‡∏î‡πâ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏µ‡πâ‡πÄ‡∏•‡∏¢‡∏ô‡∏∞‡πÅ‡∏ï‡πà‡∏ß‡πà‡∏≤‡∏Å‡∏≤‡∏£‡∏à‡∏≤‡∏Å‡∏Å‡∏±‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ô‡∏µ‡πâ‡πÄ‡∏£‡∏≤‡πÑ‡∏°‡πà‡∏ö‡∏≠‡∏Å‡∏•‡∏≤‡∏´‡∏£‡∏≠‡∏Å‡∏ô‡∏∞:)
‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡πÄ‡∏£‡∏≤‡∏Ñ‡∏¥‡∏î‡∏ß‡πà‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏á‡πÄ‡∏£‡∏≤‡∏Å‡πá‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡πÄ‡∏à‡∏≠‡∏Å‡∏±‡∏ô‡πÄ‡∏£‡∏≤‡∏à‡∏∞‡∏£‡∏≠‡∏ß‡∏±‡∏ô‡∏ô‡∏±‡πâ‡∏ô‡∏ô‡∏∞
‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏ß‡πà‡∏≤‡πÄ‡∏£‡∏≤‡∏¢‡∏±‡∏á‡∏°‡∏µ‡∏≠‡∏µ‡∏Å‡∏´‡∏•‡∏≤‡∏¢‡πÜ‡∏ó‡∏µ‡πà ‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏≤‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ß‡πà‡∏≤‡∏à‡∏∞‡πÑ‡∏õ‡∏î‡πâ‡∏ß‡∏¢‡∏Å‡∏±‡∏ô
‡πÄ‡∏£‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÑ‡∏õ‡∏î‡πâ‡∏ß‡∏¢‡∏Å‡∏±‡∏ô‡πÄ‡∏•‡∏¢‡∏ô‡∏∞ ‡∏¢‡∏±‡∏á‡∏°‡∏µ‡∏≠‡∏µ‡∏Å‡∏´‡∏•‡∏≤‡∏¢‡πÜ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà
‡πÑ‡∏î‡πâ‡∏ó‡∏≥‡∏î‡πâ‡∏ß‡∏¢‡∏Å‡∏±‡∏ô‡πÄ‡∏•‡∏¢‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏á‡∏±‡πâ‡∏ô‡πÄ‡∏£‡∏≤‡∏à‡∏∞‡∏£‡∏≠‡∏ô‡πâ‡∏≠‡∏á‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡∏ó‡∏≥‡πÑ‡∏õ‡∏û‡∏£‡πâ‡∏≠‡∏°
‡∏Å‡∏±‡∏ö‡πÄ‡∏£‡∏≤‡∏ô‡∏∞‡∏Ñ‡∏£‡∏±‡∏ö
‡∏£‡∏±‡∏Å‡∏ô‡πâ‡∏≠‡∏á‡πÄ‡∏û‡∏•‡∏á‡πÄ‡∏™‡∏°‡∏≠‡∏ô‡∏∞
‡∏à‡∏≤‡∏Å‡πÇ‡∏≠‡πä‡∏Ñ
‡∏õ‡∏•.‡πÄ‡∏£‡∏≤‡∏ï‡∏±‡πâ‡∏á‡πÉ‡∏à‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏à‡∏î‡∏´‡∏°‡∏≤‡∏¢‡∏ó‡∏±‡πâ‡∏á2‡∏â‡∏ö‡∏±‡∏ö‡∏ô‡∏µ‡πâ‡∏°‡∏≤‡∏Å‡πÜ‡πÄ‡∏•‡∏¢‡∏ô‡∏∞‡∏Ñ‡∏£‡∏±‡∏ö
‡∏≠‡∏¢‡∏≤‡∏Å‡πÉ‡∏´‡πâ‡∏ô‡πâ‡∏≠‡∏á‡πÑ‡∏î‡πâ‡∏≠‡πà‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á2‡∏â‡∏ö‡∏±‡∏ö‡πÄ‡∏•‡∏¢‡πÅ‡∏ï‡πà‡∏ß‡πà‡∏≤‡∏≠‡∏µ‡∏Å‡∏â‡∏ö‡∏±‡∏ö‡∏ô‡∏∂‡∏á‡πÄ‡∏£‡∏≤‡∏Ç‡∏≠
‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ß‡πâ‡πÄ‡∏õ‡∏¥‡∏î‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏±‡∏ö‡∏ô‡πâ‡∏≠‡∏á‡πÄ‡∏û‡∏•‡∏á‡∏ô‡∏∞‡∏Ñ‡∏£‡∏±‡∏öüòâ`;
let anim1=false, anim2=false;
btnAnim1.addEventListener('click', ()=>{ anim1=!anim1; envOpen.classList.toggle('open',anim1); });
btnAnim2.addEventListener('click', ()=>{ anim2=!anim2; envLocked.classList.toggle('open',anim2); });
btnOpenNow.addEventListener('click', ()=>{
  envOpen.classList.add('open'); anim1=true;
  blast(innerWidth/2, innerHeight*0.35, 180); chime();
  openA4('‡∏à‡∏î‡∏´‡∏°‡∏≤‡∏¢‡∏ñ‡∏∂‡∏á‡∏ô‡πâ‡∏≠‡∏á‡πÄ‡∏û‡∏•‡∏á üíå', OPEN_TEXT, []);
});
envOpen.addEventListener('click', ()=> btnOpenNow.click());

// Locked logic (‡πÑ‡∏°‡πà‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏ß‡∏•‡∏≤)
const target = new Date(CONFIG.OPEN_AT);
const CIRC = 2*Math.PI*48;
const bar = document.querySelector('.progress .bar');
bar.setAttribute('stroke-dasharray', CIRC.toFixed(2));
bar.setAttribute('stroke-dashoffset', CIRC.toFixed(2));

function updateRing(){
  if (isNaN(target)) return;
  const now = new Date(); const diff = target-now;
  if (diff<=0){
    bar.setAttribute('stroke-dashoffset','0');
    if (CONFIG.AUTO_OPEN) showLockedLetter(true);
    return;
  } else {
    if (!updateRing.start) updateRing.start = now.getTime();
    const total = target.getTime() - updateRing.start;
    const passed = now.getTime() - updateRing.start;
    const ratio = Math.max(0, Math.min(1, passed/Math.max(1,total)));
    bar.setAttribute('stroke-dashoffset', (CIRC*(1-ratio)).toFixed(2));
    setTimeout(updateRing, 1000);
  }
}
updateRing();

let lockedShown = false;
function showLockedLetter(fromAuto=false){
  if (lockedShown) return;
  lockedShown = true;
  envLocked.classList.add('open'); anim2=true;
  blast(innerWidth/2, innerHeight*0.25, 150); chime();
  openA4(CONFIG.LOCKED_TITLE, CONFIG.LOCKED_CONTENT, CONFIG.LOCKED_IMAGES);
  if (!fromAuto && navigator.vibrate) navigator.vibrate(20);
}
btnOpenLocked.addEventListener('click', ()=>{
  if (isNaN(target)) return;
  if (new Date()>=target){ showLockedLetter(false); }
  else {
    envLocked.classList.add('shake');
    setTimeout(()=>envLocked.classList.remove('shake'),520);
    const r=envLocked.getBoundingClientRect(); blast(r.left+r.width/2, r.top+20);
    if (navigator.vibrate) navigator.vibrate([20,20,10]);
  }
});
envLocked.addEventListener('click', ()=> btnOpenLocked.click());

// Theme + sound
toggleTheme.addEventListener('click', ()=>{
  const cur=document.documentElement.getAttribute('data-theme'); const next=cur==='dark'?'light':'dark';
  document.documentElement.setAttribute('data-theme',next); localStorage.setItem('theme', next);
  toggleTheme.classList.toggle('active', next==='dark');
});
toggleTheme.classList.toggle('active', (savedTheme|| (prefersDark?'dark':'light'))==='dark');

toggleSound.addEventListener('click', ()=>{
  soundOn=!soundOn; toggleSound.classList.toggle('active', soundOn);
  toggleSound.textContent=`‡πÄ‡∏™‡∏µ‡∏¢‡∏á: ${soundOn?'‡πÄ‡∏õ‡∏¥‡∏î':'‡∏õ‡∏¥‡∏î'}`; localStorage.setItem('sound', soundOn?'on':'off'); if (soundOn) chime();
});

// Secret hearts
const code=['ArrowUp','ArrowUp','ArrowDown','ArrowDown','ArrowLeft','ArrowRight','ArrowLeft','ArrowRight','KeyB','KeyA']; let pos=0;
addEventListener('keydown', e=>{ pos = (e.code===code[pos]) ? pos+1 : 0; if (pos===code.length){ pos=0; stickerBurst(); }});
secretBtn.addEventListener('click', stickerBurst);
function stickerBurst(){
  for(let i=0;i<20;i++){
    const s=document.createElement('div'); s.textContent=['üíñ','üíò','üíù','üíó','üíû'][Math.floor(Math.random()*5)];
    s.style.position='fixed'; s.style.left=(10+Math.random()*80)+'vw'; s.style.top='-10vh';
    s.style.fontSize=(26+Math.random()*24)+'px'; s.style.transition='transform 2s ease, opacity 2s ease';
    s.style.transform='translateY(0) rotate(0)'; s.style.opacity='1'; s.style.pointerEvents='none'; document.body.appendChild(s);
    requestAnimationFrame(()=>{ s.style.transform=`translateY(${110+Math.random()*20}vh) rotate(${(Math.random()*720-360).toFixed(0)}deg)`; s.style.opacity='0'; });
    setTimeout(()=> s.remove(), 2200);
  }
  blast(innerWidth/2, innerHeight*0.2, 220); chime();
}
</script>
</body>
</html>
