<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Image Upload Challenge</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            margin: 0;
            padding: 0;
        }
        .container {
            max-width: 900px;
            margin: 40px auto;
            background: #fff;
            border-radius: 18px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.15);
            padding: 32px 24px 32px 24px;
        }
        .header {
            text-align: center;
            margin-bottom: 32px;
        }
        .header h1 {
            font-size: 2.2em;
            color: #2c3e50;
        }
        .score {
            font-size: 2.5em;
            font-weight: bold;
            color: #27ae60;
            margin-bottom: 10px;
        }
        .upload-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
            gap: 24px;
            margin-bottom: 32px;
        }
        .upload-card {
            background: #f8f9fa;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.07);
            padding: 20px 16px;
            text-align: center;
            border: 2px solid transparent;
            transition: border 0.2s;
        }
        .upload-card.active { border-color: #2980b9; }
        .upload-card.completed { border-color: #27ae60; background: #eafaf1; }
        .upload-card.missed { border-color: #e74c3c; background: #fdecea; }
        .upload-card h3 { margin-bottom: 10px; color: #34495e; }
        .timer { font-size: 1.2em; margin-bottom: 10px; }
        .upload-btn {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: bold;
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: #fff;
            cursor: pointer;
            margin-bottom: 10px;
            transition: background 0.2s;
        }
        .upload-btn:disabled {
            background: #b2bec3;
            color: #636e72;
            cursor: not-allowed;
        }
        .file-input { display: none; }
        .image-preview {
            max-width: 100%;
            max-height: 120px;
            border-radius: 8px;
            margin-top: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.10);
        }
        .status { margin-top: 8px; font-weight: bold; }
        .status.success { color: #27ae60; }
        .status.missed { color: #e74c3c; }
        .progress-bar {
            width: 100%;
            height: 10px;
            background: #ecf0f1;
            border-radius: 5px;
            overflow: hidden;
            margin: 18px 0 32px 0;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #27ae60, #2980b9);
            width: 0%;
            transition: width 0.3s;
        }
        .final-results {
            display: none;
            text-align: center;
            margin-top: 32px;
        }
        .final-results h2 { color: #2c3e50; margin-bottom: 16px; }
        .final-score { font-size: 2.5em; font-weight: bold; margin-bottom: 18px; }
        .reset-btn {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: #fff;
            border: none;
            padding: 12px 28px;
            border-radius: 8px;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
            margin-top: 18px;
            transition: background 0.2s;
        }
        .reset-btn:hover { background: #c0392b; }
        @media (max-width: 700px) {
            .container { padding: 12px; }
            .upload-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ðŸŽ¯ Image Upload Challenge</h1>
            <div class="score" id="scoreDisplay">100</div>
            <div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div>
        </div>
        <div class="upload-grid" id="uploadGrid"></div>
        <div class="final-results" id="finalResults">
            <h2>ðŸŽ‰ Challenge Complete!</h2>
            <div class="final-score" id="finalScore">100</div>
            <button class="reset-btn" onclick="resetChallenge()">Start New Challenge</button>
            <div class="upload-grid" id="galleryGrid"></div>
        </div>
    </div>
    <script>
    // --- CONFIG ---
    const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwEZw6pQsp6U398NzJYgLf__-Mw9cZPSJ2dFitC-60NA37qfvB1kARswMLeO84E4Lwa-g/exec';
        const TOTAL_UPLOADS = 6;
        const INITIAL_SCORE = 100;
    const UPLOAD_INTERVALS = [0, 30, 60, 90, 120, 150]; // à¸™à¸²à¸—à¸µ
    const UPLOAD_WINDOW = 3; // à¸™à¸²à¸—à¸µ
        const PENALTIES = [30, 5, 10, 15, 15, 15];

    // --- STATE ---
        let gameState = {
            score: INITIAL_SCORE,
        uploads: Array(TOTAL_UPLOADS).fill(null),
            startTime: null,
            gameComplete: false,
        userId: 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9)
    };

    // --- UI GENERATION ---
    function renderUploadGrid() {
        const grid = document.getElementById('uploadGrid');
        grid.innerHTML = '';
        for (let i = 0; i < TOTAL_UPLOADS; i++) {
            const upload = gameState.uploads[i];
            const card = document.createElement('div');
            card.className = 'upload-card';
            if (upload?.completed) card.classList.add('completed');
            if (upload?.missed) card.classList.add('missed');
            if (canUpload(i)) card.classList.add('active');
            card.innerHTML = `
                <h3>Upload ${i + 1}</h3>
                <div class="timer" id="timer-${i}">${getTimerText(i)}</div>
                <button class="upload-btn" id="btn-${i}" ${canUpload(i) ? '' : 'disabled'} onclick="triggerUpload(${i})">Select Image</button>
                <input type="file" class="file-input" id="file-${i}" accept="image/*" capture="environment" onchange="handleFileSelect(${i}, this)">
                <div class="status ${upload?.completed ? 'success' : upload?.missed ? 'missed' : ''}" id="status-${i}">
                    ${upload?.completed ? 'Uploaded at ' + upload.timestamp : upload?.missed ? 'Missed' : ''}
                </div>
                <img class="image-preview" id="preview-${i}" style="display:${upload?.completed ? 'block' : 'none'};" src="${upload?.imageData || ''}">
            `;
            grid.appendChild(card);
        }
    }

    function getTimerText(i) {
        const upload = gameState.uploads[i];
        if (upload?.completed) return 'Completed âœ“';
        if (upload?.missed) return 'Missed âœ—';
        if (!gameState.startTime && i === 0) return 'Ready to upload';
        if (!gameState.startTime) return 'Waiting...';
        const now = Date.now();
        const elapsed = (now - gameState.startTime) / 60000;
        if (elapsed < UPLOAD_INTERVALS[i]) {
            const wait = UPLOAD_INTERVALS[i] - elapsed;
            const m = Math.floor(wait);
            const s = Math.floor((wait - m) * 60);
            return `Next in ${m}:${s.toString().padStart(2, '0')}`;
        }
        const windowEnd = UPLOAD_INTERVALS[i] + UPLOAD_WINDOW;
        if (elapsed < windowEnd) {
            const left = windowEnd - elapsed;
            const m = Math.floor(left);
            const s = Math.floor((left - m) * 60);
            return `${m}:${s.toString().padStart(2, '0')} left`;
        }
        return 'Missed âœ—';
    }

    function canUpload(i) {
        if (gameState.uploads[i]?.completed || gameState.uploads[i]?.missed) return false;
        if (!gameState.startTime) return i === 0;
        const now = Date.now();
        const elapsed = (now - gameState.startTime) / 60000;
        if (elapsed >= UPLOAD_INTERVALS[i] && elapsed < UPLOAD_INTERVALS[i] + UPLOAD_WINDOW) return true;
        return false;
    }

    // --- UPLOAD LOGIC ---
    function triggerUpload(i) {
        document.getElementById(`file-${i}`).click();
    }
    function handleFileSelect(i, input) {
        const file = input.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            processImage(i, e.target.result, file.name);
        };
        reader.readAsDataURL(file);
    }
    function processImage(i, imageData, fileName) {
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        const img = new Image();
        img.onload = function() {
            canvas.width = img.width;
            canvas.height = img.height;
            ctx.drawImage(img, 0, 0);
            const timestamp = new Date().toLocaleTimeString();
            const fontSize = Math.max(20, Math.min(img.width / 20, img.height / 20));
            ctx.fillStyle = 'rgba(0,0,0,0.7)';
            ctx.fillRect(10, 10, fontSize * 6, fontSize * 1.5);
            ctx.fillStyle = 'white';
            ctx.font = `bold ${fontSize}px Arial`;
            ctx.fillText(timestamp, 20, 20 + fontSize * 0.7);
            const timestampedImage = canvas.toDataURL('image/png');
            gameState.uploads[i] = {
                completed: true,
                timestamp,
                imageData: timestampedImage,
                fileName
            };
            if (i === 0 && !gameState.startTime) {
                gameState.startTime = Date.now();
                startMainTimer();
            }
            renderUploadGrid();
            updateProgress();
            showModal('âœ… Upload Successful!', `Upload ${i + 1} submitted successfully with timestamp ${timestamp}.`);
            saveUploadToSheets(i, gameState.uploads[i]);
            checkGameComplete();
        };
        img.src = imageData;
    }
    function saveUploadToSheets(i, uploadData) {
        const rowData = [
            gameState.userId,
            new Date().toISOString(),
            `Upload ${i + 1}`,
            uploadData.timestamp,
            uploadData.fileName,
            'Completed',
            uploadData.imageData // à¸ªà¹ˆà¸‡ base64 à¹€à¸•à¹‡à¸¡ à¹„à¸¡à¹ˆà¸•à¸±à¸”
        ];
        fetch(APPS_SCRIPT_URL, {
            method: 'POST',
            body: JSON.stringify(rowData),
            headers: { 'Content-Type': 'application/json' }
        });
    }
    // --- TIMER ---
    let mainTimer = null;
    function startMainTimer() {
        if (mainTimer) return;
        mainTimer = setInterval(() => {
            renderUploadGrid();
            updateProgress();
            checkMissedUploads();
        }, 1000);
    }
    function checkMissedUploads() {
        if (!gameState.startTime) return;
        const now = Date.now();
        const elapsed = (now - gameState.startTime) / 60000;
        for (let i = 0; i < TOTAL_UPLOADS; i++) {
            if (!gameState.uploads[i] && elapsed >= UPLOAD_INTERVALS[i] + UPLOAD_WINDOW) {
                gameState.uploads[i] = { missed: true };
                gameState.score -= PENALTIES[i];
            }
        }
    }
    // --- PROGRESS ---
    function updateProgress() {
        const completed = gameState.uploads.filter(u => u?.completed).length;
        const progress = (completed / TOTAL_UPLOADS) * 100;
        document.getElementById('progressFill').style.width = `${progress}%`;
        document.getElementById('scoreDisplay').textContent = gameState.score;
    }
    // --- GAME COMPLETE ---
    function checkGameComplete() {
        const completed = gameState.uploads.filter(u => u?.completed).length;
        const missed = gameState.uploads.filter(u => u?.missed).length;
        if (completed + missed === TOTAL_UPLOADS && !gameState.gameComplete) {
            gameState.gameComplete = true;
            clearInterval(mainTimer);
            showFinalResults();
            saveGameResults();
        }
    }
    function showFinalResults() {
        document.getElementById('finalResults').style.display = 'block';
        document.getElementById('finalScore').textContent = gameState.score;
        const grid = document.getElementById('galleryGrid');
        grid.innerHTML = '';
        gameState.uploads.forEach((upload, i) => {
            if (upload?.completed) {
                const card = document.createElement('div');
                card.className = 'upload-card completed';
                card.innerHTML = `
                    <h3>Upload ${i + 1}</h3>
                    <img class="image-preview" src="${upload.imageData}">
                    <div class="status success">Timestamp: ${upload.timestamp}</div>
                `;
                grid.appendChild(card);
            }
        });
    }
    function saveGameResults() {
                const completedUploads = gameState.uploads.filter(u => u?.completed).length;
                const missedUploads = gameState.uploads.filter(u => u?.missed).length;
                const rowData = [
                    gameState.userId,
                    new Date().toISOString(),
                    gameState.score,
                    completedUploads,
                    missedUploads,
                    JSON.stringify(gameState.uploads.map(u => ({
                        completed: u?.completed || false,
                        missed: u?.missed || false,
                        timestamp: u?.timestamp || null,
                        fileName: u?.fileName || null
                    })))
                ];
        fetch(APPS_SCRIPT_URL, {
            method: 'POST',
            body: JSON.stringify(rowData),
            headers: { 'Content-Type': 'application/json' }
        });
    }
    // --- MODAL ---
    function showModal(title, message) {
        let modal = document.getElementById('modal');
        if (!modal) {
            modal = document.createElement('div');
            modal.id = 'modal';
            modal.style.position = 'fixed';
            modal.style.zIndex = 1000;
            modal.style.left = 0;
            modal.style.top = 0;
            modal.style.width = '100%';
            modal.style.height = '100%';
            modal.style.background = 'rgba(0,0,0,0.5)';
            modal.innerHTML = `<div style="background:#fff;margin:15% auto;padding:30px;border-radius:15px;max-width:400px;text-align:center;box-shadow:0 10px 40px rgba(0,0,0,0.2);">
                <h3 id="modalTitle"></h3>
                <p id="modalMessage"></p>
                <button onclick="closeModal()" style="background:linear-gradient(135deg,#3498db,#2980b9);color:#fff;border:none;padding:10px 22px;border-radius:8px;font-weight:bold;cursor:pointer;">OK</button>
            </div>`;
            document.body.appendChild(modal);
        }
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalMessage').textContent = message;
        modal.style.display = 'block';
        }
        function closeModal() {
        const modal = document.getElementById('modal');
        if (modal) modal.style.display = 'none';
        }
    // --- RESET ---
        function resetChallenge() {
            gameState = {
                score: INITIAL_SCORE,
            uploads: Array(TOTAL_UPLOADS).fill(null),
                startTime: null,
            gameComplete: false,
            userId: 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9)
        };
        document.getElementById('finalResults').style.display = 'none';
        renderUploadGrid();
        updateProgress();
        if (mainTimer) clearInterval(mainTimer);
        mainTimer = null;
    }
    // --- INIT ---
    window.onload = function() {
        renderUploadGrid();
        updateProgress();
        };
    </script>
</body>
</html>